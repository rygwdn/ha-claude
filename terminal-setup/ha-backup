#!/usr/bin/env bash
# ha-backup — Home Assistant Backup CLI (terminal/SSH edition)
# Uses curl + SUPERVISOR_TOKEN, no Node.js required.

set -euo pipefail

HELP="ha-backup — Home Assistant Backup CLI

Usage:
  ha-backup create [name]    Create a partial backup (config + addons)
  ha-backup list             List existing backups
  ha-backup --help           Show this help

Environment:
  SUPERVISOR_TOKEN  Set automatically inside HA add-on / Terminal add-on

Examples:
  ha-backup create \"before-dashboard-changes\"
  ha-backup list
"

: "${SUPERVISOR_TOKEN:?Error: SUPERVISOR_TOKEN not set. Run inside the HA Terminal add-on.}"

SUP_URL="http://supervisor"

sup_get() {
  curl -sf -H "Authorization: Bearer $SUPERVISOR_TOKEN" "${SUP_URL}${1}"
}

sup_post() {
  local path="$1"
  local body="${2:-{}}"
  curl -sf -X POST -H "Authorization: Bearer $SUPERVISOR_TOKEN" -H "Content-Type: application/json" \
    -d "$body" "${SUP_URL}${path}"
}

if [[ $# -eq 0 || "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  echo "$HELP"
  exit 0
fi

CMD="$1"
shift

case "$CMD" in
  create)
    name="${1:-claude-backup-$(date -u +%Y-%m-%dT%H-%M-%S)}"
    echo "Creating backup: ${name}..."
    body=$(printf '{"name":"%s","homeassistant":true,"addons":[],"folders":["homeassistant"]}' "$name")
    result=$(sup_post "/backups/new/partial" "$body")
    slug=$(echo "$result" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('data',{}).get('slug',''))" 2>/dev/null || true)
    if [[ -n "$slug" ]]; then
      echo "Backup created: $slug"
      echo "Name: $name"
    else
      echo "Backup created successfully"
    fi
    ;;

  list)
    sup_get "/backups" | python3 -c "
import json, sys
result = json.load(sys.stdin)
backups = result.get('data', {}).get('backups', [])
if not backups:
    print('No backups found')
    sys.exit(0)
print('Backups:')
from datetime import datetime
for b in sorted(backups, key=lambda x: x.get('date',''), reverse=True):
    try:
        dt = datetime.fromisoformat(b['date'].replace('Z','+00:00')).astimezone()
        date_str = dt.strftime('%Y-%m-%d %H:%M:%S')
    except Exception:
        date_str = b.get('date','?')
    size = b.get('size', 0)
    size_str = f'{size:.1f} MB' if size else ''
    print(f'  {b[\"name\"]} — {date_str} ({b.get(\"type\",\"?\")}) {size_str}')
    print(f'    slug: {b[\"slug\"]}')
print(f'\nTotal: {len(backups)} backups')
"
    ;;

  *)
    echo "Unknown command: $CMD" >&2
    echo "Run 'ha-backup --help' for usage" >&2
    exit 1
    ;;
esac
