#!/usr/bin/env bash
# ha-api — Home Assistant REST API CLI (terminal/SSH edition)
# Covers operations not available in hass-cli or the ha CLI.
# Uses curl + SUPERVISOR_TOKEN, no Node.js required.

set -euo pipefail

HELP="ha-api — Home Assistant REST API CLI

Usage:
  ha-api call <domain>.<service> [json]   Call a service with optional data
  ha-api history <entity_id> [--hours N]  Get entity state history (default: 24h)
  ha-api config                           Get HA core configuration
  ha-api --help                           Show this help

For most other queries, prefer built-in tools:
  hass-cli state list / get <entity>      Entity states
  hass-cli service list / call            Services
  hass-cli device list                    Devices
  hass-cli area list                      Areas
  ha core logs                            Logs
  ha core check                           Config validation
  ha backups list / new                   Backups

Environment:
  SUPERVISOR_TOKEN  Set automatically inside HA add-on / Terminal add-on

Examples:
  ha-api call light.turn_on '{\"entity_id\": \"light.living_room\", \"brightness\": 128}'
  ha-api history sensor.temperature --hours 48
"

: "${SUPERVISOR_TOKEN:?Error: SUPERVISOR_TOKEN not set. Run inside the HA Terminal add-on.}"

HA_URL="http://supervisor/core/api"

ha_get() {
  curl -sf -H "Authorization: Bearer $SUPERVISOR_TOKEN" -H "Content-Type: application/json" \
    "${HA_URL}${1}"
}

ha_post() {
  local path="$1"
  local body="${2:-{}}"
  curl -sf -X POST -H "Authorization: Bearer $SUPERVISOR_TOKEN" -H "Content-Type: application/json" \
    -d "$body" "${HA_URL}${path}"
}

if [[ $# -eq 0 || "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  echo "$HELP"
  exit 0
fi

CMD="$1"
shift

case "$CMD" in
  call)
    if [[ $# -lt 1 ]]; then
      echo "Usage: ha-api call <domain>.<service> [json_data]" >&2
      exit 1
    fi
    svc="$1"
    body="${2:-{}}"
    domain="${svc%%.*}"
    service="${svc#*.}"
    if [[ -z "$domain" || -z "$service" || "$domain" == "$service" ]]; then
      echo "Service must be in format: domain.service (e.g., light.turn_on)" >&2
      exit 1
    fi
    ha_post "/services/${domain}/${service}" "$body" | python3 -m json.tool
    ;;

  config)
    ha_get "/config" | python3 -m json.tool
    ;;

  history)
    if [[ $# -lt 1 ]]; then
      echo "Usage: ha-api history <entity_id> [--hours N]" >&2
      exit 1
    fi
    entity_id="$1"; shift
    hours=24
    while [[ $# -gt 0 ]]; do
      case "$1" in
        --hours) hours="$2"; shift 2 ;;
        *) shift ;;
      esac
    done
    python3 -c "
import subprocess, json, sys
from datetime import datetime, timedelta, timezone
hours = $hours
entity = '$entity_id'
end = datetime.now(timezone.utc)
start = end - timedelta(hours=hours)
url = f'http://supervisor/core/api/history/period/{start.isoformat()}?filter_entity_id={entity}&end_time={end.isoformat()}'
result = subprocess.run(
    ['curl', '-sf', '-H', f'Authorization: Bearer \$SUPERVISOR_TOKEN', url],
    capture_output=True, text=True
)
data = json.loads(result.stdout)
entries = data[0] if data else []
if not entries:
    print(f'No history found for {entity} in last {hours}h')
else:
    print(f'History for {entity} (last {hours}h):')
    for e in entries:
        t = datetime.fromisoformat(e['last_changed'].replace('Z', '+00:00')).astimezone()
        print(f'  {t.strftime(\"%Y-%m-%d %H:%M:%S\")}: {e[\"state\"]}')
    print(f'\n{len(entries)} state changes')
" 2>/dev/null || {
      end_time=$(date -u +%Y-%m-%dT%H:%M:%S+00:00)
      start_time=$(date -u -d "${hours} hours ago" +%Y-%m-%dT%H:%M:%S+00:00 2>/dev/null || \
                   date -u -v-${hours}H +%Y-%m-%dT%H:%M:%S+00:00)
      curl -sf -H "Authorization: Bearer $SUPERVISOR_TOKEN" \
        "${HA_URL}/history/period/${start_time}?filter_entity_id=${entity_id}&end_time=${end_time}" \
        | python3 -m json.tool
    }
    ;;

  *)
    echo "Unknown command: $CMD" >&2
    echo "Run 'ha-api --help' for usage" >&2
    exit 1
    ;;
esac
