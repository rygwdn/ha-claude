#!/usr/bin/env bash
# ha-check — Home Assistant Configuration Validator (terminal/SSH edition)
# Uses curl + SUPERVISOR_TOKEN, no Node.js required.

set -euo pipefail

HELP="ha-check — Home Assistant Configuration Validator

Usage:
  ha-check        Validate HA configuration
  ha-check --help Show this help

Environment:
  SUPERVISOR_TOKEN  Set automatically inside HA add-on / Terminal add-on

Always run this before restarting Home Assistant.
"

: "${SUPERVISOR_TOKEN:?Error: SUPERVISOR_TOKEN not set. Run inside the HA Terminal add-on.}"

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  echo "$HELP"
  exit 0
fi

echo "Checking Home Assistant configuration..."

result=$(curl -sf -X POST \
  -H "Authorization: Bearer $SUPERVISOR_TOKEN" \
  -H "Content-Type: application/json" \
  "http://supervisor/core/api/config/core/check_config")

status=$(echo "$result" | python3 -c "import json,sys; print(json.load(sys.stdin).get('result','unknown'))" 2>/dev/null || echo "unknown")
errors=$(echo "$result" | python3 -c "import json,sys; print(json.load(sys.stdin).get('errors') or '')" 2>/dev/null || echo "")

if [[ "$status" == "valid" ]]; then
  echo "Configuration is valid!"
  exit 0
else
  echo "Configuration errors found:" >&2
  echo "${errors:-Unknown error}" >&2
  exit 1
fi
